{
    "$schema": "http://json-schema.org/draft-07/schema",
    "$id": "https://github.com/K-Cully/performance-of-microservices/ClusterGeneration/schema",
    "title": "Application",
    "description": "The applciation topology to be generated",
    "definitions": {
        "requestProcessor": {
            "description": "Configuration for a request processor",
            "type": "object",
            "properties": {
                "type": {
                    "enum": [
                        "RequestProcessor"
                    ]
                },
                "value": {
                    "type": "object",
                    "properties": {
                        "steps": {
                            "description": "The ordered list of steps to be executed by the processor",
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "errorSize": {
                            "description": "The size in bytes of an error response",
                            "type": "integer",
                            "multipleOf": 1,
                            "minimum": 0
                        },
                        "successSize": {
                            "description": "The size in bytes of a success response",
                            "type": "integer",
                            "multipleOf": 1,
                            "minimum": 0
                        },
                        "latency": {
                            "description": "Simulated latency in milliseconds to add to all requests",
                            "type": "integer",
                            "multipleOf": 1,
                            "minimum": 0
                        }
                    },
                    "required": [
                        "errorSize",
                        "successSize",
                        "latency",
                        "steps"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "startupProcessor": {
            "description": "Configuration for a startup processor",
            "type": "object",
            "properties": {
                "type": {
                    "enum": [
                        "StartupProcessor"
                    ]
                },
                "value": {
                    "type": "object",
                    "properties": {
                        "steps": {
                            "description": "The ordered list of steps to be executed by the processor",
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "asynchronous": {
                            "description": "Whether processor execution should be asynchronous or not",
                            "type": "boolean"
                        }
                    },
                    "required": [
                        "asynchronous",
                        "steps"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "processors": {
            "description": "Processors which chain emulated business logic steps",
            "type": "object",
            "additionalProperties": {
                "anyOf": [
                    { "$ref": "#/definitions/startupProcessor" },
                    { "$ref": "#/definitions/requestProcessor" }
                ]
            }
        },
        "steps": {
            "description": "Emulated business logic steps",
            "type": "object",
            "additionalProperties": {
                "description": "A step configuration",
                "type": "object",
                "properties": {
                    "type": {
                        "description": "The type of step to create",
                        "type": "string",
                        "enum": [
                            "DelayStep",
                            "ErrorStep",
                            "LoadStep",
                            "RequestStep"
                        ]
                    },
                    "value": {
                        "description": "Configuration values for the specific step type",
                        "type": "object"
                    },
                    "parallelCount": {
                        "description": "The number of parallel executions of the step",
                        "type": "integer",
                        "minimum": 0,
                        "multipleOf": 1
                    },
                    "parallelError": {
                        "description": "A clause for how parallel execution errors affect the step result",
                        "type": "string",
                        "enum": [
                            "All",
                            "Any",
                            "None"
                        ]
                    }
                },
                "required": [
                    "type",
                    "value"
                ]
            }
        },
        "clients": {
            "description": "Http request clients",
            "type": "object",
            "additionalProperties": {
                "description": "The http client to use for requests to a host",
                "type": "object",
                "properties": {
                    "baseAddress": {
                        "description": "The domain and (optionally) port of the host to connect to",
                        "type": "string"
                    },
                    "policies": {
                        "description": "A list of policies to apply to all requests through the client",
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    },
                    "headers": {
                        "description": "A dictionary of headers to apply to all requests through the client",
                        "type": "object",
                        "additionalProperties": {
                            "description": "A header key-value pair",
                            "type": "string"
                        }
                    }
                },
                "required": [
                    "baseAddress",
                    "policies"
                ]
            }
        },
        "policies": {
            "description": "Resiliancy policies for http requests",
            "type": "object",
            "additionalProperties": {
                "description": "The policy to be created",
                "type": "object",
                "properties": {
                    "type": {
                        "description": "The type of the policy config defined",
                        "type": "string",
                        "enum": [
                            "AdvancedCircuitBreakerConfig",
                            "BulkheadConfig",
                            "CacheConfig",
                            "CircuitBreakerConfig",
                            "FallbackConfig",
                            "RetryConfig",
                            "TimeoutConfig"
                        ]
                    },
                    "value": {
                        "description": "The configuration values for the specified type",
                        "type": "object"
                    }
                },
                "required": [
                    "type",
                    "value"
                ]
            }
        }
    },
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string"
        },
        "appsettingsPath": {
            "description": "A complete path to a substitute appsettings.json file for services",
            "type": "string"
        },
        "aiKey": {
            "description": "An instrumentation key for service connectivity to Application Insights",
            "type": "string"
        },
        "services": {
            "description": "The dictionary of services to create as part of the application",
            "type": "object",
            "additionalProperties": {
                "description": "The service to be generated",
                "type": "object",
                "properties": {
                    "comment": {
                        "description": "Details about the service",
                        "type": "string"
                    },
                    "port": {
                        "description": "The unique port to listen for requests on",
                        "type": "integer",
                        "minimum": 1,
                        "multipleOf": 1
                    },
                    "processors": {
                        "$ref": "#/definitions/processors"
                    },
                    "steps": {
                        "$ref": "#/definitions/steps"
                    },
                    "clients": {
                        "$ref": "#/definitions/clients"
                    },
                    "policies": {
                        "$ref": "#/definitions/policies"
                    }
                },
                "required": [
                    "port",
                    "processors",
                    "steps"
                ]
            }
        }
    },
    "required": [
        "services"
    ]
}