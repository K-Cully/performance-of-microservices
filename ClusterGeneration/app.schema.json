{
    "$schema": "http://json-schema.org/draft-07/schema",
    "$id": "https://github.com/K-Cully/performance-of-microservices/ClusterGeneration/schema",
    "title": "Application",
    "description": "The applciation topology to be generated",
    "definitions": {
        "processorValues": {
            "description": "Configuration for all processors",
            "type": "object",
            "properties": {
                "type": {
                    "type": "string"
                },
                "value": {
                    "type": "object",
                    "properties": {
                        "steps": {
                            "description": "The ordered list of steps to be executed by the processor",
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        }
                    },
                    "required": [
                        "steps"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "requestProcessor": {
            "allOf": [
                {
                    "$ref": "#/definitions/processorValues"
                },
                {
                    "description": "Configuration for a request processor",
                    "type": "object",
                    "properties": {
                        "type": {
                            "type": "string",
                            "enum": [
                                "RequestProcessor"
                            ]
                        },
                        "value": {
                            "type": "object",
                            "properties": {
                                "errorSize": {
                                    "description": "The size in bytes of an error response",
                                    "type": "integer",
                                    "multipleOf": 1,
                                    "minimum": 0
                                },
                                "successSize": {
                                    "description": "The size in bytes of a success response",
                                    "type": "integer",
                                    "multipleOf": 1,
                                    "minimum": 0
                                },
                                "latency": {
                                    "description": "Simulated latency in milliseconds to add to all requests",
                                    "type": "integer",
                                    "multipleOf": 1,
                                    "minimum": 0
                                }
                            },
                            "required": [
                                "errorSize",
                                "successSize",
                                "latency"
                            ]
                        }
                    }
                }
            ]
        },
        "startupProcessor": {
            "allOf": [
                {
                    "$ref": "#/definitions/processorValues"
                },
                {
                    "description": "Configuration for a startup processor",
                    "type": "object",
                    "properties": {
                        "type": {
                            "type": "string",
                            "enum": [
                                "StartupProcessor"
                            ]
                        },
                        "value": {
                            "type": "object",
                            "properties": {
                                "asynchronous": {
                                    "description": "Whether processor execution should be asynchronous or not",
                                    "type": "boolean"
                                }
                            },
                            "required": [
                                "asynchronous"
                            ]
                        }
                    }
                }
            ]
        },
        "processors": {
            "description": "Processors which chain emulated business logic steps",
            "type": "object",
            "additionalProperties": {
                "anyOf": [
                    {
                        "$ref": "#/definitions/startupProcessor"
                    },
                    {
                        "$ref": "#/definitions/requestProcessor"
                    }
                ]
            }
        },
        "delayStep": {
            "description": "A delay step configuration",
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "DelayStep"
                    ]
                },
                "value": {
                    "description": "Configuration values",
                    "type": "object",
                    "properties": {
                        "time": {
                            "type": "number",
                            "minimum": 0
                        },
                        "parallelCount": {
                            "description": "The number of parallel executions of the step",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "parallelError": {
                            "description": "A clause for how parallel execution errors affect the step result",
                            "type": "string",
                            "enum": [
                                "All",
                                "Any",
                                "None"
                            ]
                        }
                    },
                    "required": [
                        "time"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "errorStep": {
            "description": "An error step configuration",
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "ErrorStep"
                    ]
                },
                "value": {
                    "description": "Configuration values",
                    "type": "object",
                    "properties": {
                        "probability": {
                            "type": "number",
                            "minimum": 0,
                            "maximum": 1.0
                        },
                        "parallelCount": {
                            "description": "The number of parallel executions of the step",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "parallelError": {
                            "description": "A clause for how parallel execution errors affect the step result",
                            "type": "string",
                            "enum": [
                                "All",
                                "Any",
                                "None"
                            ]
                        }
                    },
                    "required": [
                        "probability"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "loadStep": {
            "description": "A load step configuration",
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "LoadStep"
                    ]
                },
                "value": {
                    "description": "Configuration values",
                    "type": "object",
                    "properties": {
                        "bytes": {
                            "description": "The amount of bytes to consume",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "time": {
                            "description": "The time in seconds to run for. (negative == forever)",
                            "type": "number"
                        },
                        "percent": {
                            "description": "The percentage of processor time to consume",
                            "type": "integer",
                            "minimum": 0,
                            "maximum": 100,
                            "multipleOf": 1
                        },
                        "processors": {
                            "description": "The maximum number of processors to load. (0 == all available)",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "parallelCount": {
                            "description": "The number of parallel executions of the step",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "parallelError": {
                            "description": "A clause for how parallel execution errors affect the step result",
                            "type": "string",
                            "enum": [
                                "All",
                                "Any",
                                "None"
                            ]
                        }
                    },
                    "required": [
                        "bytes",
                        "time",
                        "percent"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "requestStep": {
            "description": "A request step configuration",
            "type": "object",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "RequestStep"
                    ]
                },
                "value": {
                    "description": "Configuration values",
                    "type": "object",
                    "properties": {
                        "cacheId": {
                            "type": "string"
                        },
                        "cacheKeyUniqueness": {
                            "type": "integer",
                            "minimum": 1,
                            "multipleOf": 1
                        },
                        "client": {
                            "description": "The name of the client to use for requests",
                            "type": "string"
                        },
                        "method": {
                            "description": "The http method type",
                            "type": "string"
                        },
                        "path": {
                            "description": "A path to append to the client request",
                            "type": "string",
                            "default": "/"
                        },
                        "size": {
                            "description": "The request size in bytes",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "reuseSockets": {
                            "description": "Whether sockets should be reused between requests or not",
                            "type": "boolean"
                        },
                        "trueAsync": {
                            "description": "Whether requests should fire-and-forget or await responses",
                            "type": "boolean"
                        },
                        "parallelCount": {
                            "description": "The number of parallel executions of the step",
                            "type": "integer",
                            "minimum": 0,
                            "multipleOf": 1
                        },
                        "parallelError": {
                            "description": "A clause for how parallel execution errors affect the step result",
                            "type": "string",
                            "enum": [
                                "All",
                                "Any",
                                "None"
                            ]
                        }
                    },
                    "required": [
                        "client",
                        "method",
                        "path",
                        "size",
                        "reuseSockets",
                        "trueAsync"
                    ]
                }
            },
            "required": [
                "type",
                "value"
            ]
        },
        "steps": {
            "description": "Emulated business logic steps",
            "type": "object",
            "additionalProperties": {
                "anyOf": [
                    {
                        "$ref": "#/definitions/delayStep"
                    },
                    {
                        "$ref": "#/definitions/errorStep"
                    },
                    {
                        "$ref": "#/definitions/loadStep"
                    },
                    {
                        "$ref": "#/definitions/requestStep"
                    }
                ]
            }
        },
        "clients": {
            "description": "Http request clients",
            "type": "object",
            "additionalProperties": {
                "description": "The http client to use for requests to a host",
                "type": "object",
                "properties": {
                    "baseAddress": {
                        "description": "The domain and (optionally) port of the host to connect to",
                        "type": "string"
                    },
                    "policies": {
                        "description": "A list of policies to apply to all requests through the client",
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    },
                    "headers": {
                        "description": "A dictionary of headers to apply to all requests through the client",
                        "type": "object",
                        "additionalProperties": {
                            "description": "A header key-value pair",
                            "type": "string"
                        }
                    }
                },
                "required": [
                    "baseAddress",
                    "policies"
                ]
            }
        },
        "policies": {
            "description": "Resiliancy policies for http requests",
            "type": "object",
            "additionalProperties": {
                "description": "The policy to be created",
                "type": "object",
                "properties": {
                    "type": {
                        "description": "The type of the policy config defined",
                        "type": "string",
                        "enum": [
                            "AdvancedCircuitBreakerConfig",
                            "BulkheadConfig",
                            "CacheConfig",
                            "CircuitBreakerConfig",
                            "FallbackConfig",
                            "RetryConfig",
                            "TimeoutConfig"
                        ]
                    },
                    "value": {
                        "description": "The configuration values for the specified type",
                        "type": "object"
                    }
                },
                "required": [
                    "type",
                    "value"
                ]
            }
        }
    },
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string"
        },
        "appsettingsPath": {
            "description": "A complete path to a substitute appsettings.json file for services",
            "type": "string"
        },
        "aiKey": {
            "description": "An instrumentation key for service connectivity to Application Insights",
            "type": "string"
        },
        "services": {
            "description": "The dictionary of services to create as part of the application",
            "type": "object",
            "additionalProperties": {
                "description": "The service to be generated",
                "type": "object",
                "properties": {
                    "comment": {
                        "description": "Details about the service",
                        "type": "string"
                    },
                    "port": {
                        "description": "The unique port to listen for requests on",
                        "type": "integer",
                        "minimum": 1,
                        "multipleOf": 1
                    },
                    "processors": {
                        "$ref": "#/definitions/processors"
                    },
                    "steps": {
                        "$ref": "#/definitions/steps"
                    },
                    "clients": {
                        "$ref": "#/definitions/clients"
                    },
                    "policies": {
                        "$ref": "#/definitions/policies"
                    }
                },
                "required": [
                    "port",
                    "processors",
                    "steps"
                ]
            }
        }
    },
    "required": [
        "services"
    ]
}